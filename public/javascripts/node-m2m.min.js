var NodeM2M=function(){const w=new class{constructor(){this.target=new EventTarget}on(t,e){return this.target.addEventListener(t,e)}once(t,e){return this.target.addEventListener(t,e,{once:!0})}off(t,e){return this.target.removeEventListener(t,e)}emit(t,e){return this.target.dispatchEvent(new CustomEvent(t,{detail:e,cancelable:!0}))}};navigator.userAgent;var r,y=function(){var e="https://www.node-m2m.com",n=!1;var t="xxxxxxxx-xxxx-5xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)});function i(t){return function(t){for(var e="",n=0;n<t;n++)e+="x";return e}(t).replace(/[xy]/g,t=>{var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}var o=i(8);sessionStorage.getItem("clientId")?o=sessionStorage.getItem("clientId"):sessionStorage.setItem("clientId",o);let r={_sid:"m2m",_pid:"b-c",src:"browser-client",b:!0,browser:!0,uid:t,id:o,appId:o,appIds:[o],event:!1,watch:!1,active:!0,enable:!0,tid:Date.now()};o={type:"browser",mem:"-",m2mv:"v1.0.1",os:navigator.platform,browser:!0,online:navigator.onLine,language:navigator.language};return r.systemInfo=o,{pl:r,rid:i,systemInfo:o,getValidUrl:function(){return n},setValidUrl:function(t){n=t},setDataEvent:function(e,n){if(0<n.length)for(let t=0;t<n.length;t++){if(n[t]&&e.name&&e.event&&n[t].id===e.id&&n[t].name===e.name)return!0;if(n[t]&&e.input&&e.event&&n[t].id===e.id&&n[t].pin===e.pin)return!0;if(n[t]&&e.output&&e.event&&n[t].id===e.id&&n[t].pin===e.pin)return!0}return n.push(e),!1},getDefaultUrl:function(){return e},setDefaultUrl:function(t){return e=t}}}(),t=(r=y.rid(12),{get:function(t,e){!1===b.getConnectionStatus()?setTimeout(function(){n(t,"GET",e)},2e3):n(t,"GET",e)},post:function(t,e){!1===b.getConnectionStatus()?setTimeout(function(){n(t,"POST",e)},2e3):n(t,"POST",e)}});function n(t,e,n){if(!y.pl.accessTkn)return n("unauthorized");if(!y.pl.aid)return n("unauthorized");if(t.apiKey||(t.apiKey=y.pl.appId),"object"!=typeof t)return n("invalid option");if(!t.id)return n("missing deviceId");if(!t.path)return n("missing http path");var i=(o=t,y.getDefaultUrl()+"/custom-api/"+r+"?path="+o.path+"&id="+o.id),o={headers:{Authorization:"Bearer "+y.pl.appId,"X-API-Key":t.apiKey,"Content-Type":"application/x-www-form-urlencoded","x-spl":JSON.stringify(y.pl)},method:"GET",referrerPolicy:"no-referrer"};if("GET"===e)o.method=e;else if("POST"===e){if(!t.body)return console.log("post error: invalid body"),n("invalid post body");o.method=e,"object"==typeof t.body?o.body="data="+JSON.stringify(t.body):o.body="data="+t.body}fetch(i,o).then(function(t){return t.json()}).then(function(t){return t.error?n(t.error):void("object"==typeof t&&t.result?t.result.data?n(t.result.data):n(t.result):n(t))}).catch(function(t){t&&n(t)})}var e,o,a,c,u,b=(e=new EventTarget,o=null,c=!(a={}),u=0,{connect:async function(e,n){var t,i;"object"==typeof e&&e.aKey?function(t,e){let n=null,i=null;if(t.path||(n="/node-m2m"),t.path&&(n=t.path),t.aKey&&t.aKey.length<12)return console.log("invalid key"),e("invalid aKey");t.aKey&&11<t.aKey.length&&(i=t.aKey),fetch(n,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({key:i,sec:t.sec})}).then(function(t){return t.json()}).then(function(t){!t.error&&e&&t.tkn?e(t.tkn):console.log("unauthorized")}).catch(function(t){t&&console.log("error:",t)})}(e,function(t){console.log("connect ..."),y.pl.accessTkn=t,e.url&&p(e),y.pl.accessTkn&&(y.pl.browserId=y.pl.accessTkn.slice(7,31));d(y.pl,n)}):(i=n,"object"==typeof(t=e)?(t.accessTkn&&(y.pl.accessTkn=t.accessTkn),t.tkn&&(y.pl.accessTkn=t.tkn),t.url&&p(t)):"string"==typeof t?y.pl.accessTkn=t:i("invalid access token"),y.pl.accessTkn&&(y.pl.browserId=y.pl.accessTkn.slice(7,31)),d(y.pl,i))},webSocket:function(){return o},getEventEmitter:function(){return e},getConnectionStatus:function(){return c},setConnectionStatus:function(t){return c=t}});function s(t,e,n){125===e.code&&e.aid?(delete(t.pl=e).code,console.log("connection: success"),n&&n()):"unauthorized"===e.result&&console.log("connection: unauthorized")}function l(t){var e=null;t.device&&t.activeStart?i.clientDeviceActiveStartProcess(t):t.exit?i.clientDeviceOffLineProcess(t):t.getDevices||t.deviceSetup?e=t.id+t._pid:t.channel||t.name?e=t.id+t.name+t.eventId:t.gpioInput||t.input?e=t.id+t._pid+t.pin+t.event+t.watch:(t.gpioOutput||t.output)&&(e=t.id+t.pin+t.eventId),w.emit(e,t)}function d(e,i){var t=y.getDefaultUrl().replace("https","wss");(o=new WebSocket(t+"/m2m")).onerror=function(t){"error"===t.type&&o.readyState},o.onopen=function(t){1===o.readyState&&(c=!0,o.send(JSON.stringify(e)))},o.onmessage=function(t){try{1===o.readyState&&(a=JSON.parse(t.data),!Array.isArray(a)&&0<Object.keys(a).length?setTimeout(s,10,y,a,i):Array.isArray(a)&&0<Object.keys(a[0]).length&&(a=a[0],setTimeout(l,10,a)))}catch(t){}},o.onclose=function(t){var e,n;1006===t.code&&i&&i("remote server is down or is not ready"),e=t,n=i,t=Math.floor(1e4*Math.random()+7e3),1006!==e.code&&1003!==e.code||(c?(0===u&&console.log("Server is not ready\nAttempt to reconnect 1 ..."),1===u&&console.log("There is no response from server","\nAttempt to reconnect 2 ..."),2===u&&console.log("Cannot establish a connection with the server"),3===u&&console.log("Waiting for the server to be up and running ..."),setTimeout(d,t,y.pl,n),u++):console.log("Server is not ready or available. Please try again later."))}}function p(t){t.url.includes("https")?y.setDefaultUrl(t.url):(console.log("connect url must be secure TLS"),t.url=null)}var i=function(){b.getEventEmitter();var e=0,o=1500,r=[],a=[],c=[];function u(t,e,n){1===e.readyState&&(y.pl.aid?e.send(JSON.stringify(n)):setTimeout(function(){e.send(JSON.stringify(n))},t))}function n(e,t){var n=b.webSocket();t.length<1||t.forEach(function(t){t.id===e.id&&e.active&&(t.aid=e.aid,!t.device&&t.event&&(t.name||t.input)&&1===n.readyState&&n.send(JSON.stringify(t)))})}function i(n,t){t.forEach(t=>{var e;t.id===n.id&&((n=Object.assign({},t)).error="device["+t.id+"] is off-line",t.name?(n.name=t.name,e=t.id+t.name+t.event+t.watch,w.emit(e,n)):t.input&&(n.input=t.input,e=t.id+t._pid+t.pin+t.event+t.watch,w.emit(e,n)))})}function s(e,n,i){if(0<n.length)for(let t=0;t<n.length;t++)try{if(n[t]&&e.name&&e.unwatch&&n[t].id===e.id&&n[t].name===e.name)return n.splice(t,1),i(null,!0);if(n[t]&&e.input&&e.unwatch&&n[t].id===e.id&&n[t].pin===e.pin)return n.splice(t,1),i(null,!0);if(n[t]&&e.output&&e.unwatch&&n[t].id===e.id&&n[t].pin===e.pin)return n.splice(t,1),i(null,!0)}catch(t){console.log("removeActiveSyncDataEvent error",t),i(t,null)}}function l(t,e,n){var i=b.webSocket();if(1===i.readyState){var o=Object.assign({},y.pl);if(delete o.accessTkn,o._pid="channel-data",o.id=t.id,o.event=!1,o.watch=!1,o.channel=t.channel,o.name=t.channel,o.dst="device",o.eventId=y.rid(12),t.path&&(o.name=t.path),"getData"===e&&(o.method="getData",o.getData=!0),"sendData"===e&&(o.method="sendData",o.sendData=!0,t.payload&&(o.payload=t.payload,o.method="sendData")),"get"===e&&(o.get=!0,o.method="get",o.api=o.name),"post"===e&&(o.post=!0,o.method="post",o.api=o.name,t.body&&(o.body=t.body),!o))throw new Error("invalid/missing body");if("unwatch"===e&&(o.unwatch=!0,o.method="unwatch"),"watch"===e&&(o.watch=!0,o.method="watch",o.interval=5e3,t.interval&&(o.interval=t.interval)),!o._pid)throw new Error("invalid _pid");o.watch?(o.watch=!0,o.event=!0):(o.watch=!1,o.event=!1),function(t,n){let i=t.id+t.name+t.eventId;function o(t){t=t.detail;if(n)return t.error?n(t.error):t.unwatch?(s(t,a,(t,e)=>t?n(t,null):void w.off(i,o)),n(t.result)):void(t.value?n(t.value):t.result&&n(t.result))}t.event?(y.setDataEvent(t,a)&&w.off(i,o),w.on(i,o)):w.once(i,o)}(o,n),1===i.readyState&&i.send(JSON.stringify(o))}}function d(t,n){let i=null;function o(t){t=t.detail;if(n)return t.error?n(t.error):t.unwatch?(s(t,c,(t,e)=>t?n(t,null):void w.off(i,o)),n(t.result)):void n(t.state)}t.gpioInput||t.input?i=t.id+t._pid+t.pin+t.event+t.watch:(t.gpioOutput||t.output)&&(i=t.id+t.pin+t.eventId),t.event?(y.setDataEvent(t,c)&&w.off(i,o),w.on(i,o)):w.once(i,o)}function p(e,n,t,i,o){var r=b.webSocket();if(1===r.readyState){var a=Object.assign({},y.pl);if(delete a.accessTkn,a.input=!0,a.gpioInput=!0,a.dst="device",a.eventId=y.rid(12),"object"==typeof e){let t=e;n&&"object"==typeof n&&(t=n,t.id=e),t.id&&(a.id=t.id),t.pin&&(a.pin=t.pin),t.interval&&(a.interval=t.interval),t.poll&&(a.interval=t.poll)}else e&&(a.id=e),n&&(a.pin=n);if("state"===t){if(a._pid="gpio-input-state",a.getState=!0,!o)throw new Error("callback argument is required")}else if("unwatch"===t)a._pid="gpio-input",a.unwatch=!0;else{if("watch"!==t)throw new Error("invalid argugment");a._pid="gpio-input",a.watch=!0,a.interval=5e3}if("gpio-input-state"!==a._pid&&(a._pid="gpio-input"),a.watch?(a.watch=!0,a.event=!0,a.interval=5e3):(a.watch=!1,a.event=!1),!a._pid)throw new Error("invalid _pid");if(i&&Number.isInteger(i)&&(a.interval=i),i&&!Number.isInteger(i))throw new Error("invalid poll interval");if(o&&"function"!=typeof o)throw new Error("invalid callback argument");d(a,o),1===r.readyState&&r.send(JSON.stringify(a))}}var t=function(t){var e=this.id;y.pl.aid?p(e,null,"state",null,t):setTimeout(function(){p(e,null,"state",null,t)},o)},f=function(){try{throw new Error("invalid input method")}catch(t){throw console.error("input",t),t}};function h(t,e){this.id=t,this.pin=e}function v(e,n,t,i,o){if(1===b.webSocket().readyState){var r,a,c=Object.assign({},y.pl);if(delete c.accessTkn,c.gpioOutput=!0,c.state=null,c.event=!1,c.watch=!1,c.dst="device","object"==typeof e){let t=e;n&&"object"==typeof n&&(t=n,t.id=e),t.id&&(c.id=t.id),t.pin&&(c.pin=t.pin),t.interval&&(c.interval=t.interval),t.poll&&(c.interval=t.poll)}else e&&(c.id=e),n&&(c.pin=n);if("state"===t){if(c._pid="gpio-output-state",c.output="state",!o)throw new Error("callback argument is required")}else if("on"===t)c._pid="gpio-output-on",c.output="on",c.on=!0;else{if("off"!==t)throw new Error("invalid method argument");c._pid="gpio-output-off",c.output="off",c.off=!0}if(!c._pid)throw new Error("invalid _pid");if(i&&"number"==typeof i&&(c.t=i),i&&"function"==typeof i&&(o=i),i&&!Number.isInteger(i)&&"function"!=typeof i)throw new Error("invalid time delay");if(o&&"function"!=typeof o)throw new Error("invalid callback argument");d(c,o),i=i,r=c,1===(a=b.webSocket()).readyState&&("number"!=typeof i||0===i?a.send(JSON.stringify(r)):setTimeout(function(){a.send(JSON.stringify(r))},i))}}h.prototype={constructor:h,on:f,off:f,state:t,getState:t,unwatch:function(t){var e=this.id;y.pl.aid?p(e,null,"unwatch",null,t):setTimeout(function(){p(e,null,"unwatch",null,t)},o)},watch:function(t,e){"function"==typeof t&&(e=t,t=null);var n=this.id;y.pl.aid?p(n,null,"watch",t,e):setTimeout(function(){p(n,null,"watch",t,e)},o)}};f=function(){try{throw new Error("invalid output method")}catch(t){throw console.error("output",t),t}},t=function(t){var e=this.id;y.pl.aid?v(e,null,"state",null,t):setTimeout(function(){v(e,null,"state",null,t)},o)};function g(t,e){this.id=t,this.pin=e}function m(t,e){var n=b.webSocket(),i=Object.assign({},y.pl);if(delete i.accessTkn,"function"!=typeof t||e?"number"==typeof t&&"function"==typeof e&&(i.id=t):(e=t,i.id=this.id),!e)throw new Error("callback is required");i.dst="device",i.deviceSetup=!0,i._pid="deviceSetup";t=i.id+i._pid;w.once(t,function(t){if((t=t.detail).id===i.id&&t.deviceSetup&&e){if(t.error)return e(t.error);e(t.deviceSetup)}}),u(o,n,i)}return g.prototype={constructor:g,watch:f,unwatch:f,state:t,getState:t,on:function(t,e){var n=this.id;y.pl.aid?v(n,null,"on",t,e):setTimeout(function(){v(n,null,"on",t,e)},o)},off:function(t,e){var n=this.id;y.pl.aid?v(n,null,"off",t,e):setTimeout(function(){v(n,null,"off",t,e)},o)}},{cli:async function(t,e){if(!y.pl.accessTkn)return e("unauthorized");"object"==typeof t&&(t.channel="sec-cli",t.cmd&&(t.payload=t.cmd),t.command&&(t.payload=t.command)),y.pl.aid?l(t,"sendData",e):setTimeout(function(){l(t,"sendData",e)},o)},get:async function(t,e){if(!y.pl.accessTkn)return e("unauthorized");y.pl.aid?l(t,"get",e):setTimeout(function(){l(t,"get",e)},o)},post:async function(t,e){if(!y.pl.accessTkn)return e("unauthorized");y.pl.aid?l(t,"post",e):setTimeout(function(){l(t,"post",e)},o)},gpio:function(t,e){if(y.pl.accessTkn,"input"===t.mode||"in"===t.mode)return new h(t,null);if("output"===t.mode||"out"===t.mode)return new g(t,null);throw new Error("invalid arguments")},watch:async function(t,e){if(!y.pl.accessTkn)return e("unauthorized");y.pl.aid?l(t,"watch",e):setTimeout(function(){l(t,"watch",e)},o)},input:function(t,e){return y.pl.accessTkn,new h(t,null)},output:function(t,e){return y.pl.accessTkn,new g(t,null)},unwatch:async function(t,e){if(!y.pl.accessTkn)return e("unauthorized");y.pl.aid?l(t,"unwatch",e):setTimeout(function(){l(t,"unwatch",e)},o)},getData:async function(t,e){if(!y.pl.accessTkn)return e("unauthorized");y.pl.aid?l(t,"getData",e):setTimeout(function(){l(t,"getData",e)},o)},sendData:async function(t,e){if(!y.pl.accessTkn)return e("unauthorized");y.pl.aid?l(t,"sendData",e):setTimeout(function(){l(t,"sendData",e)},o)},getDevices:function(e){var t=b.webSocket();if(r&&0<r.length)return e(r);var n=Object.assign({},y.pl);delete n.accessTkn,n._pid="getDevices",n.getDevices=!0;var i=n.id+n._pid;w.once(i,function(t){if((t=t.detail).id===n.id&&t.devices&&e){if(t.error)return e(t.error);r=t.devices,e(t.devices)}}),u(o,t,n)},resourcesInfo:m,clientDeviceOffLineProcess:function(t){i(t,a),i(t,c),Number.isInteger(t.id)&&console.log("device["+t.id+"] is offline"),e=0},clientDeviceActiveStartProcess:function(t){n(t,a),n(t,c),0===e&&(console.log("device["+t.id+"] is online"),e++)}}}();return{Client:{Client:function(){y.pl.options||(y.pl.options={}),0<arguments.length&&"object"==typeof arguments[0]&&(y.pl.options.userSettings=arguments[0],y.pl.options.userSettings.src="browser"),this.cli=i.cli,this.in=i.input,this.out=i.output,this.get=t.get,this.post=t.post,this.gpio=i.gpio,this.watch=i.watch,this.input=i.input,this.output=i.output,this.unwatch=i.unwatch,this.getData=i.getData,this.sendData=i.sendData,this.getDevices=i.getDevices,this.resourcesInfo=i.resourcesInfo,this.getResources=i.resourcesInfo,this.connect=b.connect}}.Client}}();