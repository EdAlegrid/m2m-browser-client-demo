var NodeM2M=function(){const t=new class{constructor(){this.target=new EventTarget}on(t,e){return this.target.addEventListener(t,e)}once(t,e){return this.target.addEventListener(t,e,{once:!0})}off(t,e){return this.target.removeEventListener(t,e)}emit(t,e){return this.target.dispatchEvent(new CustomEvent(t,{detail:e,cancelable:!0}))}};navigator.userAgent;var e=function(){var t="https://www.node-m2m.com",e=!1,n="xxxxxxxx-xxxx-5xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}));function i(t){return function(t){for(var e="",n=0;n<t;n++)e+="x";return e}(t).replace(/[xy]/g,(t=>{var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}var o=i(8);sessionStorage.getItem("clientId")?o=sessionStorage.getItem("clientId"):sessionStorage.setItem("clientId",o);var r={_sid:"m2m",_pid:"b-c",src:"browser-client",b:!0,browser:!0,uid:n,id:o,appId:o,appIds:[o],src:"browser-client",event:!1,watch:!1,active:!0,enable:!0,tid:Date.now()};const a={nodev:"-",npmv:"-",type:"browser",mem:"-",m2mv:"v1.0.6",os:navigator.platform,browser:!0,online:navigator.onLine,language:navigator.language};return r.systemInfo=a,{pl:r,rid:i,systemInfo:a,getValidUrl:function(){return e},setValidUrl:function(t){e=t},setDataEvent:function(t,e){if(e.length>0)for(var n=0;n<e.length;n++){if(e[n]&&t.name&&t.event&&e[n].id===t.id&&e[n].name===t.name)return!0;if(e[n]&&t.input&&t.event&&e[n].id===t.id&&e[n].pin===t.pin)return!0;if(e[n]&&t.output&&t.event&&e[n].id===t.id&&e[n].pin===t.pin)return!0}return e.push(t),!1},getDefaultUrl:function(){return t},setDefaultUrl:function(e){return t=e}}}(),n=(e.rid(12),function(){var n=new EventTarget,o=null,r={},a=!1;function c(t,e,n){if(125===e.code&&e.aid)t.pl=e,delete e.code,console.log("connection: success"),n&&n();else if("unauthorized"===e.result)return void console.log("connection: unauthorized")}function s(e){var n=null;e.device&&e.activeStart?i.clientDeviceActiveStartProcess(e):e.exit?i.clientDeviceOffLineProcess(e):e.getDevices||e.deviceSetup?n=e.id+e._pid:e.channel||e.name?n=e.id+e.name+e.event+e.watch+e.unwatch+e.method:(e.gpioInput||e.input||e.gpioOutput||e.output)&&(n=e.id+e._pid+e.pin+e.event+e.watch),t.emit(n,e)}var u=0;function l(t,n){var i=e.getDefaultUrl().replace("https","wss");(o=new WebSocket(i+"/m2m")).onerror=function(t){"error"===t.type&&o.readyState},o.onopen=function(e){1===o.readyState&&(a=!0,o.send(JSON.stringify(t)))},o.onmessage=function(t){try{1===o.readyState&&(r=JSON.parse(t.data),!Array.isArray(r)&&Object.keys(r).length>0?setTimeout(c,10,e,r,n):Array.isArray(r)&&Object.keys(r[0]).length>0&&(r=r[0],setTimeout(s,10,r)))}catch(t){}},o.onclose=function(t){1006===t.code&&n&&n("remote server is down or is not ready"),function(t,n){var i=Math.floor(1e4*Math.random()+7e3);if(1006===t.code||1003===t.code){if(!a)return void console.log("Server is not ready or available. Please try again later.");0===u&&console.log("Server is not ready\nAttempt to reconnect 1 ..."),1===u&&console.log("There is no response from server","\nAttempt to reconnect 2 ..."),2===u&&console.log("Cannot establish a connection with the server"),3===u&&console.log("Waiting for the server to be up and running ..."),setTimeout(l,i,e.pl,n),u++}}(t,n)}}function d(t){t.url.includes("https")?e.setDefaultUrl(t.url):(console.log("connect url must be secure TLS"),t.url=null)}return{connect:async function(t,n){"object"==typeof t&&t.aKey?function(t,e){var n=null,i=null;if(t.path||(n="/node-m2m"),t.path&&(n=t.path),t.aKey&&t.aKey.length<12)return console.log("invalid key"),e("invalid aKey");t.aKey&&t.aKey.length>11&&(i=t.aKey),fetch(n,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({key:i,sec:t.sec})}).then((function(t){return t.json()})).then((function(t){t.error?console.log("unauthorized"):e&&t.tkn?e(t.tkn):console.log("unauthorized")})).catch((function(t){t&&console.log("error:",t)}))}(t,(function(i){console.log("connect ..."),e.pl.accessTkn=i,t.url&&d(t),e.pl.accessTkn&&(e.pl.browserId=e.pl.accessTkn.slice(7,31)),l(e.pl,n)})):function(t,n){"object"==typeof t?(t.accessTkn&&(e.pl.accessTkn=t.accessTkn),t.tkn&&(e.pl.accessTkn=t.tkn),t.url&&d(t)):"string"==typeof t?e.pl.accessTkn=t:n("invalid access token"),e.pl.accessTkn&&(e.pl.browserId=e.pl.accessTkn.slice(7,31)),l(e.pl,n)}(t,n)},webSocket:function(){return o},getEventEmitter:function(){return n},getConnectionStatus:function(){return a},setConnectionStatus:function(t){return a=t}}}()),i=function(){n.getEventEmitter();var i=0,o=1500,r=[],a=[],c=[];function s(t,n,i){1===n.readyState&&(e.pl.aid?n.send(JSON.stringify(i)):setTimeout((function(){n.send(JSON.stringify(i))}),t))}function u(t,e){var i=n.webSocket();e.length<1||e.forEach((function(e){e.id===t.id&&t.active&&(e.aid=t.aid,!e.device&&e.event&&(e.name||e.input)&&1===i.readyState&&i.send(JSON.stringify(e)))}))}function l(e,n){n.forEach((n=>{if(n.id===e.id)if((e=Object.assign({},n)).error="device["+n.id+"] is off-line",n.name){e.name=n.name;var i=n.id+n.name+n.event+n.watch;t.emit(i,e)}else n.input&&(e.input=n.input,i=n.id+n._pid+n.pin+n.event+n.watch,t.emit(i,e))}))}function d(t,e,n){if(e.length>0)for(var i=0;i<e.length;i++)try{if(e[i]&&t.name&&t.unwatch&&e[i].id===t.id&&e[i].name===t.name)return e.splice(i,1),n(null,!0);if(e[i]&&t.input&&t.unwatch&&e[i].id===t.id&&e[i].pin===t.pin)return e.splice(i,1),n(null,!0);if(e[i]&&t.output&&t.unwatch&&e[i].id===t.id&&e[i].pin===t.pin)return e.splice(i,1),n(null,!0)}catch(t){console.log("removeActiveSyncDataEvent error",t),n(t,null)}}function p(i,o,r){var c=n.webSocket();if(1===c.readyState){var s=Object.assign({},e.pl);if(delete s.accessTkn,s._pid="channel-data",s.dst="device",s.eventId=e.rid(12),s.event=!1,s.watch=!1,i.channel&&(s.name=i.channel,s.channel=i.channel),i.topic&&(s.name=i.topic,s.channel=i.topic),i.path&&(s.name=i.path,s.path=i.path,s.originalUrl=i.path,function(t,e){let n=null,i=null;const o=[],r=[],a={};if(!e.startsWith("/")){let t="invalid url, it must begin with a slash /";throw console.log(t),t}let c=e.indexOf("?",1);-1!==c&&(n=e.substring(c+1,e.length)),new URLSearchParams(n).forEach((function(t,e){a[e]=t}));let s=e.indexOf("?");-1!==s&&(e=e.slice(0,s));for(let t=0;t<e.length;t++)"/"===e[t]&&o.push(t);o.forEach(((t,n)=>{if(0==t&&o[n+1]){let t=e.slice(o[n],o[n+1]);r.push(t)}else if(0!==t&&o[n]&&o[n+1]){let t=e.slice(o[n],o[n+1]);r.push(t)}else{let t=e.slice(o[n],e.length);r.push(t)}}));let u=r[0].length;i=e.indexOf("?"),-1===i&&(i=e.length);let l=e.slice(u,i);t.urlPathKeys=r,t.baseUrl=r[0],t.pathUrl=l,t.queryString=n,t.query=a}(s,i.path)),i.interval&&(s.interval=i.interval),i.poll&&(s.interval=i.poll),s.device?(s.srcId||(s.srcId=s.id),s.src="device-as-client"):s.srcId||(s.srcId=s.id),s.id=i.id,s.srcId===i.id)throw new Error("Invalid id causing a race condition");if(s.dstId=i.id,"getData"===o)s._pid="channel-data",s.channel=s.name,s.getData=!0,s.method="getData";else if("sendData"===o){if(s._pid="channel-data",s.channel=s.name,s.sendData=!0,s.method="sendData",i.payload&&(s.payload=i.payload),!s.payload)throw new Error("invalid/missing payload")}else if("watch"===o)s._pid="channel-data",s.channel=s.name,s.watch=!0,s.method="watch",s.interval=5e3;else if("unwatch"===o)s._pid="channel-data",s.channel=s.name,s.unwatch=!0,s.method="unwatch";else if("get"===o)s._pid="http-data",s.http=!0,s.api=s.name,s.get=!0,s.method="get";else if("post"===o&&(s._pid="http-data",s.http=!0,s.api=s.name,s.post=!0,s.method="post",i.body&&(s.body=i.body),!s.body))throw new Error("invalid/missing body");if(!s._pid)throw new Error("invalid _pid");s.http&&(s.api=s.baseUrl,s.name=s.baseUrl),s.watch?(s.watch=!0,s.event=!0):(s.watch=!1,s.event=!1),function(n,i){n.eventId=n.id+n.channel+e.rid(12);var o=n.id+n.name+n.event+n.watch+n.unwatch+n.method;function r(e){var n=e.detail;if(i){if(n.error)return i(n.error);if(n.unwatch)return d(n,a,((e,n)=>{if(e)return i(e,null);t.off(o,r)})),i(n.result);n.value?i(n.value):n.result&&i(n.result)}}if(n.event&&n.watch){if(e.setDataEvent(n,a))return void t.off(o,r);t.on(o,r)}else t.once(o,r)}(s,r),1===c.readyState&&c.send(JSON.stringify(s))}}function f(n,i){n.eventId=n.id+n._pid+n.pin+e.rid(12);var o=null;function r(e){var n=e.detail;if(i){if(n.error)return i(n.error);if(n.unwatch)return d(n,c,((e,n)=>{if(e)return i(e,null);t.off(o,r)})),i(n.result);i(n.state)}}if((n.gpioInput||n.input||n.gpioOutput||n.output)&&(o=n.id+n._pid+n.pin+n.event+n.watch),n.event&&n.watch){if(e.setDataEvent(n,c))return void t.off(o,r);t.on(o,r)}else t.once(o,r)}function h(t,i,o,r,a){var c=n.webSocket();if(1===c.readyState){var s=Object.assign({},e.pl);if(delete s.accessTkn,s.input=!0,s.gpioInput=!0,s.dst="device",s.eventId=e.rid(12),"object"==typeof t){var u=t;i&&"object"==typeof i&&((u=i).id=t),u.id&&(s.id=u.id),u.pin&&(s.pin=u.pin),u.interval&&(s.interval=u.interval),u.poll&&(s.interval=u.poll)}else t&&(s.id=t),i&&(s.pin=i);if("state"===o){if(s._pid="gpio-input-state",s.getState=!0,!a)throw new Error("callback argument is required")}else if("unwatch"===o)s._pid="gpio-input",s.unwatch=!0;else{if("watch"!==o)throw new Error("invalid argugment");s._pid="gpio-input",s.watch=!0,s.interval=5e3}if("gpio-input-state"!==s._pid&&(s._pid="gpio-input"),s.watch?(s.watch=!0,s.event=!0,s.interval=5e3):(s.watch=!1,s.event=!1),!s._pid)throw new Error("invalid _pid");if(r&&Number.isInteger(r)&&(s.interval=r),r&&!Number.isInteger(r))throw new Error("invalid poll interval");if(a&&"function"!=typeof a)throw new Error("invalid callback argument");f(s,a),1===c.readyState&&c.send(JSON.stringify(s))}}const v=function(t){var n=this.id;e.pl.aid?h(n,null,"state",null,t):setTimeout((function(){h(n,null,"state",null,t)}),o)},g=function(t,n){"function"==typeof t&&(n=t,t=null);var i=this.id;e.pl.aid?h(i,null,"watch",t,n):setTimeout((function(){h(i,null,"watch",t,n)}),o)},w=function(){try{throw new Error("invalid input method")}catch(t){throw console.error("input",t),t}};function m(t,e){this.id=t,this.pin=e}function y(t,i,o,r,a){if(1===n.webSocket().readyState){var c=Object.assign({},e.pl);if(delete c.accessTkn,c.gpioOutput=!0,c.state=null,c.event=!1,c.watch=!1,c.dst="device","object"==typeof t){var s=t;i&&"object"==typeof i&&((s=i).id=t),s.id&&(c.id=s.id),s.pin&&(c.pin=s.pin),s.interval&&(c.interval=s.interval),s.poll&&(c.interval=s.poll)}else t&&(c.id=t),i&&(c.pin=i);if("state"===o){if(c._pid="gpio-output-state",c.output="state",!a)throw new Error("callback argument is required")}else if("on"===o)c._pid="gpio-output-on",c.output="on",c.on=!0;else{if("off"!==o)throw new Error("invalid method argument");c._pid="gpio-output-off",c.output="off",c.off=!0}if(!c._pid)throw new Error("invalid _pid");if(r&&"number"==typeof r&&(c.t=r),r&&"function"==typeof r&&(a=r),r&&!Number.isInteger(r)&&"function"!=typeof r)throw new Error("invalid time delay");if(a&&"function"!=typeof a)throw new Error("invalid callback argument");f(c,a),function(t,e){var i=n.webSocket();1===i.readyState&&("number"==typeof t?0===t?i.send(JSON.stringify(e)):setTimeout((function(){i.send(JSON.stringify(e))}),t):i.send(JSON.stringify(e)))}(r,c)}}m.prototype={constructor:m,on:w,off:w,state:v,getState:v,unwatch:function(t){var n=this.id;e.pl.aid?h(n,null,"unwatch",null,t):setTimeout((function(){h(n,null,"unwatch",null,t)}),o)},watch:g,watchState:g};const b=function(){try{throw new Error("invalid output method")}catch(t){throw console.error("output",t),t}},S=function(t){var n=this.id;e.pl.aid?y(n,null,"state",null,t):setTimeout((function(){y(n,null,"state",null,t)}),o)};function T(t,e){this.id=t,this.pin=e}function k(i,r){var a=n.webSocket(),c=Object.assign({},e.pl);if(delete c.accessTkn,"function"!=typeof i||r?"number"==typeof i&&"function"==typeof r&&(c.id=i):(r=i,c.id=this.id),!r)throw new Error("callback is required");c.dst="device",c.deviceSetup=!0,c._pid="deviceSetup";var u=c.id+c._pid;t.once(u,(function(t){var e=t.detail;if(e.id===c.id&&e.deviceSetup&&r){if(e.error)return r(e.error);r(e.deviceSetup)}})),s(o,a,c)}return T.prototype={constructor:T,watch:b,unwatch:b,state:S,getState:S,on:function(t,n){var i=this.id;e.pl.aid?y(i,null,"on",t,n):setTimeout((function(){y(i,null,"on",t,n)}),o)},off:function(t,n){var i=this.id;e.pl.aid?y(i,null,"off",t,n):setTimeout((function(){y(i,null,"off",t,n)}),o)}},{cli:async function(t,n){if(!e.pl.accessTkn)return n("unauthorized");"object"==typeof t&&(t.channel="sec-cli",t.cmd&&(t.payload=t.cmd),t.command&&(t.payload=t.command)),e.pl.aid?p(t,"sendData",n):setTimeout((function(){p(t,"sendData",n)}),o)},get:async function(t,n){if(!e.pl.accessTkn)return n("unauthorized");e.pl.aid?p(t,"get",n):setTimeout((function(){p(t,"get",n)}),o)},post:async function(t,n){if(!e.pl.accessTkn)return n("unauthorized");e.pl.aid?p(t,"post",n):setTimeout((function(){p(t,"post",n)}),o)},gpio:function(t,n){if(e.pl.accessTkn,"input"===t.mode||"in"===t.mode)return new m(t,null);if("output"===t.mode||"out"===t.mode)return new T(t,null);throw new Error("invalid arguments")},watch:async function(t,n){if(!e.pl.accessTkn)return n("unauthorized");e.pl.aid?p(t,"watch",n):setTimeout((function(){p(t,"watch",n)}),o)},input:function(t,n){return e.pl.accessTkn,new m(t,null)},output:function(t,n){return e.pl.accessTkn,new T(t,null)},unwatch:async function(t,n){if(!e.pl.accessTkn)return n("unauthorized");e.pl.aid?p(t,"unwatch",n):setTimeout((function(){p(t,"unwatch",n)}),o)},getData:async function(t,n){if(!e.pl.accessTkn)return n("unauthorized");e.pl.aid?p(t,"getData",n):setTimeout((function(){p(t,"getData",n)}),o)},sendData:async function(t,n){if(!e.pl.accessTkn)return n("unauthorized");e.pl.aid?p(t,"sendData",n):setTimeout((function(){p(t,"sendData",n)}),o)},getDevices:function(i){var a=n.webSocket();if(r&&r.length>0)return i(r);var c=Object.assign({},e.pl);delete c.accessTkn,c._pid="getDevices",c.getDevices=!0;var u=c.id+c._pid;t.once(u,(function(t){var e=t.detail;if(e.id===c.id&&e.devices&&i){if(e.error)return i(e.error);r=e.devices,i(e.devices)}})),s(o,a,c)},resourcesInfo:k,resourcesInfo:k,clientDeviceOffLineProcess:function(t){l(t,a),l(t,c),Number.isInteger(t.id)&&console.log("device["+t.id+"] is offline"),i=0},clientDeviceActiveStartProcess:function(t){u(t,a),u(t,c),0===i&&(console.log("device["+t.id+"] is online"),i++)}}}(),o={Client:function(){e.pl.options||(e.pl.options={}),arguments.length>0&&"object"==typeof arguments[0]&&(e.pl.options.userSettings=arguments[0],e.pl.options.userSettings.src="browser"),this.cli=i.cli,this.in=i.input,this.out=i.output,this.get=i.get,this.post=i.post,this.gpio=i.gpio,this.input=i.input,this.output=i.output,this.unwatch=i.unwatch,this.unsub=i.unwatch,this.unsubscribe=i.unwatch,this.watch=i.watch,this.watchData=i.watch,this.sub=i.watch,this.subscribe=i.watch,this.getData=i.getData,this.sendData=i.sendData,this.read=i.getData,this.write=i.sendData,this.getDevices=i.getDevices,this.resourcesInfo=i.resourcesInfo,this.getResources=i.resourcesInfo,this.connect=n.connect}};return{Client:o.Client}}();